# This is an azure pipelines configuration generated by the script found at
# https://github.com/divvun/divvun-ci-config/azure/generate-keyboard.sh
# YOU SHOULD NOT EDIT THIS MANUALLY 
# Script commit 8bb070a5800157691d9f3ade057f126fc29e12be
# Generated on 20190516113848

trigger:
- master

jobs:
- job: 'macOS'
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - script: |
      set -e
      wget https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat-macos -O pahkat
      chmod a+x pahkat
      curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python
      git clone --branch feature/new-format https://github.com/divvun/kbdgen.git
      git clone https://github.com/divvun/divvun-ci-config.git
      cd divvun-ci-config
      sh ./install-macos.sh
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - script: |
      set -e
      python -m venv $HOME/env/py3
      source $HOME/env/py3/bin/activate
      source $HOME/.poetry/env
      export "PATH=$PATH:$(System.DefaultWorkingDirectory)"
      cd kbdgen
      poetry install
      cd "../smn.kbdgen"
      export TARGET_BUNDLE_NAME=$(cat targets/mac.yaml | grep 'bundleName:' | cut -c 13-)
      export TARGET_VERSION=$(cat targets/mac.yaml | grep 'version:' | cut -c 10-)
      kbdgen -R -t mac --ci -o output --logging=debug .
      cp "$(System.DefaultWorkingDirectory)/smn.kbdgen/output/$TARGET_BUNDLE_NAME $TARGET_VERSION.pkg" "$(System.DefaultWorkingDirectory)/smn.kbdgen/output/keyboard-smn.pkg"
      cd ..
      sh divvun-ci-config/repo/scripts/pahkat_deploy_svn.sh https://pahkat.uit.no/repo/macos-staging "$(System.DefaultWorkingDirectory)/smn.kbdgen/output/keyboard-smn.pkg" keyboard-smn $TARGET_VERSION
    displayName: 'Run kbdgen'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/smn.kbdgen/output/keyboard-smn.pkg'
      artifactName: macos
- job: 'Windows'
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - bash: |
      curl -sLo pahkat.exe https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat.exe || exit 1
      curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python || exit 1
      git clone --branch feature/new-format https://github.com/divvun/kbdgen.git || exit 1
      git clone https://github.com/divvun/divvun-ci-config.git || exit 1
      openssl aes-256-cbc -d -in ./divvun-ci-config/config.txz.enc -pass pass:$DIVVUN_KEY -out config.txz -md md5 || exit 1
      7z e config.txz || exit 1
      tar xf config.tar || exit 1
      curl -o 6aa798a39c.zip https://x.brendan.so/6aa798a39c.zip || exit 1
      7z x 6aa798a39c.zip || exit 1
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - powershell: |
      . .\divvun-ci-config\repo\scripts\PahkatDeploySvn.ps1
      $Env:PATH += "$(System.DefaultWorkingDirectory);"
      $Env:PATH += $Env:USERPROFILE + "\.poetry\bin;"
      $Env:CODESIGN_PFX = "$(System.DefaultWorkingDirectory)\enc\creds\windows\divvun.pfx"
      $Env:MSKLC_PATH = "$(System.DefaultWorkingDirectory)\msklc1.4"
      $env:VIRTUAL_ENV_DISABLE_PROMPT="true"
      python -m venv $Env:USERPROFILE\env\py3
      Invoke-Expression -Command $Env:USERPROFILE\env\py3\Scripts\Activate.ps1
      cd kbdgen
      poetry install
      cd "..\smn.kbdgen"
      kbdgen -R -t win --ci -o output --logging debug .
      $appName = $(cat targets\win.yaml | Select-String -Pattern '^appName:.*').Matches[0].Value.Substring(8).Trim().Replace(" ", "_")
      $version = $(cat targets\win.yaml | Select-String -Pattern '^version:.*').Matches[0].Value.Substring(8).Trim()
      $sourcePath = "$(System.DefaultWorkingDirectory)\smn.kbdgen\output\"+$appName+"_"+$version+".exe"
      $sourcePathWin7 = "$(System.DefaultWorkingDirectory)\smn.kbdgen\output\"+$appName+"_"+$version+".win7.exe"
      Copy-Item $sourcePath "$(System.DefaultWorkingDirectory)\smn.kbdgen\output\keyboard-smn.exe"
      Copy-Item $sourcePathWin7 "$(System.DefaultWorkingDirectory)\smn.kbdgen\output\keyboard-smn.win7.exe"
      cd ..
      PahkatDeploySvn -SvnUrl https://pahkat.uit.no/repo/windows-staging -Artifact "$(System.DefaultWorkingDirectory)\smn.kbdgen\output\keyboard-smn.exe" -Package keyboard-smn -Version $version
    displayName: 'Run kbdgen'
    env:
      CODESIGN_PW: $(pfxPassword)
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/smn.kbdgen/output/keyboard-smn.exe'
      artifactName: windows
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/smn.kbdgen/output/keyboard-smn.win7.exe'
      artifactName: windows
