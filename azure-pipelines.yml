# This is an azure pipelines configuration generated by the script found at
# https://github.com/divvun/divvun-ci-config/azure/generate-keyboard.sh
# YOU SHOULD NOT EDIT THIS MANUALLY 
# Script commit 4cae748350b662d850d252a2b50b0b39de204280
# Generated on 20190522144858

trigger:
- master

jobs:
- job: 'iOS'
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - script: |
      set -e
      curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python
      curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain nightly -y
      source $HOME/.cargo/env
      rustup target add aarch64-apple-ios
      rustup target add armv7-apple-ios
      rustup target add i386-apple-ios
      rustup target add x86_64-apple-ios
      cargo install cargo-lipo
      git clone https://github.com/fry/kbdgen
      git clone https://github.com/divvun/divvun-ci-config.git
      cd divvun-ci-config
      export TRAVIS_BUILD_DIR=$(System.DefaultWorkingDirectory)
      # sh ./install.sh
      # sh ./install-macos.sh
    displayName: 'Install prerequisites'
    # env:
    #   DIVVUN_KEY: $(divvunKey)
  - script: |
      set -e
      export TRAVIS_BUILD_DIR=$(System.DefaultWorkingDirectory)
      source $HOME/.cargo/env
      python -m venv $HOME/env/py3
      source $HOME/env/py3/bin/activate
      source $HOME/.poetry/env
      # source divvun-ci-config/enc/env.sh
      # security default-keychain -s build.keychain
      # security unlock-keychain -p travis build.keychain
      # security set-keychain-settings -t 3600 -u build.keychain
      /bin/bash divvun-ci-config/repo/scripts/download_speller.sh https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-smn/ smn.zhfst --chfst
      cd kbdgen
      poetry install
      cd "../smn.kbdgen"
      export TARGET_BUNDLE_NAME=$(cat targets/ios.yaml | grep 'bundleName:' | cut -c 13-)
      export TARGET_VERSION=$(cat targets/ios.yaml | grep 'version:' | cut -c 10-)
      kbdgen -t ios --ci -o output --logging debug .
      # fastlane pilot upload --skip_submission --skip_waiting_for_build_processing --ipa output/ios-build/ipa/HostingApp.ipa
    displayName: 'Run kbdgen'
    env:
      TEAM_ID: 2K5J2584NX